<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>æ–°è¦æŠ•ç¨¿</title>
  <meta name="viewport" content="width=device-width">
<style>
*{
    box-sizing: border-box;
}
body{
    font-family: Verdana, 'BIZ UDPGothic', sans-serif;
    font-feature-settings: 'palt';
    padding: 0;
    margin: 0;
}


#editor{
    height: 100%;
    display: grid;
    grid-template:
      "editor-input" 40px
      "editor-textarea" 1fr;
}
#editor > div{
    display: flex;
    margin-bottom: 5px;
    grid-area: editor-input;
}
#editor label{
    width: 100px;
    text-align: center;
    line-height: 32px;
    font-size: 16px;
    color: #111;
	background-image: linear-gradient(to bottom, #eee, #ccc);
    user-select: none;
    text-shadow: 2px 0px 0px #eee, -2px 0px 0px #eee, 0px 2px 0px #eee, 0px -2px 0px #eee, 1px 1px 0.5px #eee, -1px -1px 0.5px #eee, 1px -1px 0.5px #eee, -1px 1px 0.5px #eee;
}
#editor input{
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 6px 6px 3px 12px;
    font-size: 14px;
    flex: 1;
}
#editor textarea{
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 14px 10px 5px 14px;
    font-size: 15px;
    grid-area: editor-textarea;
}
#ã‚¿ã‚¤ãƒˆãƒ«æ¬„[readonly]{
    background-color: #eee;
}
textarea:focus {
    outline: none;
}
input:focus {
    outline: none;
}



#æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³,
#æ›´æ–°ãƒœã‚¿ãƒ³{
    position: fixed;
    bottom: 10px;
    right: 10px;
    background-image: linear-gradient(#84be5c 0% 60%, #5ba825 60% 100%);
	text-decoration: none;
	text-align: center;
	padding: 5px 16px;
	font-size: 16px;
	color: #fff;
	border: 1px solid #377d00;
	border-radius: 5px;
    cursor: pointer;
    user-select: none;
}
#æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³:active,
#æ›´æ–°ãƒœã‚¿ãƒ³:active {
	transform: translate(0,2px);
}
#ã‚«ãƒ†ã‚´ãƒªæ¬„{
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 6px 6px 3px 12px;
    font-size: 14px;
    width: 100%;
}

#è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„{
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 14px 10px 5px 14px;
    font-size: 15px;
    width: 100%;
    height: 15rem;
}


#å‰Šé™¤ãƒœã‚¿ãƒ³{
    background-image: linear-gradient(#ff5c40 0% 60%, #ff2600 60% 100%);
	text-decoration: none;
	text-align: center;
	padding: 5px 16px;
	font-size: 16px;
	color: #fff;
	border: 1px solid #bf1d00;
	border-radius: 5px;
    cursor: pointer;
    user-select: none;

}
#å‰Šé™¤ãƒœã‚¿ãƒ³:active {
	transform: translate(0,2px);
}


#è¨˜äº‹ä¸€è¦§è¡¨ tr:hover{
    background-color: #8cf;
}

#ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ tr:hover{
    background-color: #8cf;
}
#ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ span{
    user-select: none;
    cursor: pointer;
}

select{
	padding: 10px;
	border: 1px solid #999;
	background: #eee;
	background-image: linear-gradient(#fff 0%,#efebe1 100%);
    font-size: 18px;
}
select:focus {
    outline: none;
}
option{
    font-size: 20px;
    color: #383838;
}
option[selected][disabled] {
  display: none;
}

h2{
    position: relative;
    background: #eef1f2;
    border: solid 1px #e1e1e1;
    text-indent: 32px;
    font-size: 18px;
    padding: 8px;
    border-radius: 5px;
    color: #444;
}
h2::before {
    position: absolute;
    top: 25%;
    left: 20px;
    width: 6px;
    height: 50%;
    content: '';
    opacity: 0.2;
    border-radius: 3px;
    background: #555;
}
iframe{
    width: 100%;
    height: 100%;
}

</style>
</head>


<body>


<my-tab id="mytab">
  <section id="ç·¨é›†ãƒ‘ãƒãƒ«" data-title="ç·¨é›†" data-selected>
    <div id="editor">
      <div><label for="ã‚¿ã‚¤ãƒˆãƒ«æ¬„">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="ã‚¿ã‚¤ãƒˆãƒ«æ¬„"></div>
      <textarea id="æœ¬æ–‡æ¬„" spellcheck="false" placeholder="HTML"></textarea>
    </div>
  </section>
  <section id="å±æ€§ãƒ‘ãƒãƒ«" data-title="å±æ€§">
    <h2>ã‚«ãƒ†ã‚´ãƒª</h2><input id="ã‚«ãƒ†ã‚´ãƒªæ¬„">
    <h2>è¿½åŠ ãƒ˜ãƒƒãƒ€</h2><textarea id="è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„"></textarea>
    <h2>URL</h2><p id="è¨˜äº‹URL"></p>
    <h2>è¨˜äº‹å‰Šé™¤</h2><button id="å‰Šé™¤ãƒœã‚¿ãƒ³">è¨˜äº‹å‰Šé™¤</button>
  </section>
  <section id="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼" data-title="ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼">
    <iframe id="iframe" src="../template/preview.html"></iframe>
  </section>
  <section id="è¨˜äº‹ä¸€è¦§ãƒ‘ãƒãƒ«" data-title="è¨˜äº‹ä¸€è¦§">
    <table id="è¨˜äº‹ä¸€è¦§è¡¨"><tbody></tbody></table>
  </section>
  <section id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ‘ãƒãƒ«" data-title="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§">
    <select id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥"></select>
    <table id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨"><tbody></tbody></table>
  </section>
</my-tab>

<button id="æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³">æ–°è¦æŠ•ç¨¿</button>
<button id="æ›´æ–°ãƒœã‚¿ãƒ³">è¨˜äº‹æ›´æ–°</button>


<script src="./my-tab.js" type="module"></script>
<script type="module">
import API from './jrpc.js'

class å…¥åŠ›åé›†{
    constructor(){
        this.ã‚¿ã‚¤ãƒˆãƒ«   = ã‚¿ã‚¤ãƒˆãƒ«æ¬„.value
        this.æœ¬æ–‡       = æœ¬æ–‡æ¬„.value
        this.è¿½åŠ ãƒ˜ãƒƒãƒ€ = è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„.value
        this.ã‚«ãƒ†ã‚´ãƒª   = JSON.stringify(ã‚«ãƒ†ã‚´ãƒªæ¬„.value.split(',').map(v=>v.trim()).filter(v=>v.length))
    }

    join(fn){
        return Object.keys(this).map(fn).join()
    }
}



æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³.onclick = async function (event){
    const data   = new å…¥åŠ›åé›†()
    const result = await API.DB(`insert into ãƒã‚¹ã‚¿ãƒ¼ (${data.join(k => k)}) values (${data.join(k => `:${k}`)})`, data)
}


æ›´æ–°ãƒœã‚¿ãƒ³.onclick = async function (event){
    const data   = new å…¥åŠ›åé›†()
    const result = await API.DB(`update ãƒã‚¹ã‚¿ãƒ¼ set ${data.join(k => `${k}=:${k}`)} where ã‚¿ã‚¤ãƒˆãƒ« = :ã‚¿ã‚¤ãƒˆãƒ«`, data)
}


ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼.addEventListener('tabopen', function(event){
    iframe.å…ƒã®ãƒ˜ãƒƒãƒ€ ??= iframe.contentDocument.head.innerHTML
    iframe.contentDocument.head.innerHTML = iframe.å…ƒã®ãƒ˜ãƒƒãƒ€ + è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„.value
    iframe.contentDocument.body.innerHTML = æœ¬æ–‡æ¬„.value
})


å±æ€§ãƒ‘ãƒãƒ«.addEventListener('tabopen', function(event){
    è¨˜äº‹URL.textContent = new URL(`../${encodeURIComponent(ã‚¿ã‚¤ãƒˆãƒ«æ¬„.value)}`, document.URL)
})


è¨˜äº‹ä¸€è¦§ãƒ‘ãƒãƒ«.addEventListener('tabopen', async function(event){

    const è¨˜äº‹ä¸€è¦§ = await API.DB('select * from ãƒã‚¹ã‚¿ãƒ¼ order by ä½œæˆæ—¥æ™‚ desc', null, 'table')

    è¨˜äº‹ä¸€è¦§è¡¨.tBodies[0].innerHTML = è¨˜äº‹ä¸€è¦§.map( è¨˜äº‹ => `
      <tr>
        <td><a href="./?edit=${encodeURIComponent(è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«)}" target="_blank" title="ç·¨é›†">ğŸ“</a></td>
        <td><a href="../${encodeURIComponent(è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«)}" target="_blank">${è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«}</a></td>
      </tr>
    `).join('')
})


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ‘ãƒãƒ«.addEventListener('tabopen', async function(event){

    ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.innerHTML = '<option hidden>ğŸ“…æœˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</option>' + (await API.DirList()).map( monthly => `
      <option value="${monthly}">${monthly.replace(/(....)(..)/, '$1-$2')}</option>
    `).join('')
})


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.onchange = async function (event){

    ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨.tBodies[0].innerHTML = (await API.FileList(this.value)).map( file => `
      <tr data-path="${this.value}/${file}">
        <td><a href="../upload/${this.value}/${file}" target="_blank">${file}</td>
        <td><span>&#10006;</span></td>
      </tr>
    `).join('')
}


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨.onclick = async function (event){
    if(event.target.tagName !== 'SPAN' || !confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
        return
    }

    const tr = event.target.closest('tr')
    await API.FileDelete(tr.dataset.path)
    await tr.animate({opacity:0}, 500).finished
    tr.remove()
}


æœ¬æ–‡æ¬„.ondrop = async function(event){
    event.preventDefault()

    for(const file of event.dataTransfer.files){
        const url = await API.FileSave(file.name, file)
        console.dir(url)
    }
}


document.body.ondragover = function(event){
    event.preventDefault()
}


async function start(){
    const query = new URLSearchParams(location.search)

    if(query.has('edit')){
        const data          = await API.DB('select * from ãƒã‚¹ã‚¿ãƒ¼ where ã‚¿ã‚¤ãƒˆãƒ« = ?', query.get('edit'), 'object');
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.value    = data.ã‚¿ã‚¤ãƒˆãƒ«
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.readOnly = true
        æœ¬æ–‡æ¬„.value        = data.æœ¬æ–‡
        ã‚«ãƒ†ã‚´ãƒªæ¬„.value    = JSON.parse(data.ã‚«ãƒ†ã‚´ãƒª).join()
        è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„.value  = data.è¿½åŠ ãƒ˜ãƒƒãƒ€
        document.title      = `ã€Œ${data.ã‚¿ã‚¤ãƒˆãƒ«}ã€ã®ç·¨é›†`
        æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³.remove()
        æœ¬æ–‡æ¬„.focus()
    }
    else{
        æ›´æ–°ãƒœã‚¿ãƒ³.remove()
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.focus()
    }
}

start()
</script>


</body>
</html>