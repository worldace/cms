<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8">
  <title>æ–°è¦æŠ•ç¨¿</title>
  <meta name="viewport" content="width=device-width">
<style>
*{
    box-sizing: border-box;
}
body{
    font-family: Verdana, 'BIZ UDPGothic', sans-serif;
    font-feature-settings: 'palt';
    padding: 0;
    margin: 0;
}


#editor{
    height: 100%;
    display: grid;
    grid-template:
      "editor-input" 40px
      "editor-textarea" 1fr;
}
#editor > div{
    display: flex;
    margin-bottom: 5px;
    grid-area: editor-input;
}
#editor label{
    width: 100px;
    text-align: center;
    line-height: 30px;
    font-size: 16px;
    color: #fff;
    border: 1px solid #0077b3;
    background-image: linear-gradient(to bottom, #0088cc, #0077b3);
    border-radius: 5px 0 0 5px;
    -webkit-user-select: none;
    user-select: none;
}
#editor input{
    border-radius: 0 5px 5px 0;
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 6px 6px 3px 12px;
    font-size: 14px;
    flex: 1;
}
#editor textarea{
    border-radius: 5px;
    box-shadow: 5px 5px 5px rgba(200,200,200,0.2) inset;
    border: 1px solid #888888;
    padding: 14px 10px 5px 14px;
    font-size: 15px;
    grid-area: editor-textarea;
}
#ã‚¿ã‚¤ãƒˆãƒ«æ¬„[readonly]{
    background-color: #eee;
}

#æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³{
    position: fixed;
    bottom: 10px;
    right: 10px;
}
#æ›´æ–°ãƒœã‚¿ãƒ³{
    position: fixed;
    bottom: 10px;
    right: 10px;
}
#è¨˜äº‹ä¸€è¦§è¡¨ tr:hover{
    background-color: #eeffee;
}

#ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ tr:hover{
    background-color: #eeffee;
}
#ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨ span{
    user-select: none;
    cursor: pointer;
}
</style>
</head>


<body>


<my-tab id="mytab">
  <section id="ç·¨é›†ãƒ‘ãƒãƒ«" data-title="ç·¨é›†" data-selected>
    <div id="editor">
      <div><label for="ã‚¿ã‚¤ãƒˆãƒ«æ¬„">ã‚¿ã‚¤ãƒˆãƒ«</label><input id="ã‚¿ã‚¤ãƒˆãƒ«æ¬„"></div>
      <textarea id="æœ¬æ–‡æ¬„" spellcheck="false" placeholder="HTML"></textarea>
    <div>
  </section>
  <section id="å±æ€§ãƒ‘ãƒãƒ«" data-title="å±æ€§">
    <input id="ã‚«ãƒ†ã‚´ãƒªæ¬„">
    <textarea id="è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„"></textarea>
    <button id="å‰Šé™¤ãƒœã‚¿ãƒ³">è¨˜äº‹å‰Šé™¤</button>
  </section>
  <section id="è¨˜äº‹ä¸€è¦§ãƒ‘ãƒãƒ«" data-title="è¨˜äº‹ä¸€è¦§">
    <table id="è¨˜äº‹ä¸€è¦§è¡¨"><tbody></tbody></table>
  </section>
  <section id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ‘ãƒãƒ«" data-title="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§">
    <select id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥"><option value="">ğŸ“…æœˆåˆ¥ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§</option></select>
    <table id="ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨"><tbody></tbody></table>
  </section>
</my-tab>

<button id="æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³">æ–°è¦æŠ•ç¨¿</button><button id="æ›´æ–°ãƒœã‚¿ãƒ³">è¨˜äº‹æ›´æ–°</button>

<script type="module">
import api from './jrpc.js'
import('./my-tab.js')


function å…¥åŠ›åé›†(){
    const ã‚¿ã‚¤ãƒˆãƒ«   = ã‚¿ã‚¤ãƒˆãƒ«æ¬„.value
    const æœ¬æ–‡       = æœ¬æ–‡æ¬„.value
    const ã‚«ãƒ†ã‚´ãƒª   = JSON.stringify(ã‚«ãƒ†ã‚´ãƒªæ¬„.value.split(',').map(v=>v.trim()).filter(v=>v.length))
    const è¿½åŠ ãƒ˜ãƒƒãƒ€ = è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„.value

    return {ã‚¿ã‚¤ãƒˆãƒ«,æœ¬æ–‡,ã‚«ãƒ†ã‚´ãƒª,è¿½åŠ ãƒ˜ãƒƒãƒ€}
}


æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³.onclick = async function (event){
    const data    = å…¥åŠ›åé›†()
    const holder1 = Object.keys(data).join()
    const holder2 = Object.keys(data).map(key => `:${key}`).join()

    const result = await api.db(`insert into ãƒã‚¹ã‚¿ãƒ¼ (${holder1}) values (${holder2})`, data)
}


æ›´æ–°ãƒœã‚¿ãƒ³.onclick = async function (event){
    const data   = å…¥åŠ›åé›†()
    const holder = Object.keys(data).map(key => `${key}=:${key}`).join()

    const result = await api.db(`update ãƒã‚¹ã‚¿ãƒ¼ set ${holder} where ã‚¿ã‚¤ãƒˆãƒ« = :ã‚¿ã‚¤ãƒˆãƒ«`, data)
}


è¨˜äº‹ä¸€è¦§ãƒ‘ãƒãƒ«.addEventListener('tabopen', async function(event){
    if(!è¨˜äº‹ä¸€è¦§è¡¨.list){
        è¨˜äº‹ä¸€è¦§è¡¨.list = await api.db('select * from ãƒã‚¹ã‚¿ãƒ¼ order by ä½œæˆæ—¥æ™‚ desc', null, 'table')
        è¨˜äº‹ä¸€è¦§è¡¨.tBodies[0].innerHTML = è¨˜äº‹ä¸€è¦§è¡¨.list.map(è¨˜äº‹=>`
        <tr>
          <td><a href="../${encodeURIComponent(è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«)}" target="_blank">${è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«}</a></td>
          <td><a href="./?edit=${encodeURIComponent(è¨˜äº‹.ã‚¿ã‚¤ãƒˆãƒ«)}" target="_blank" title="ç·¨é›†">ğŸ“</a></td>
        </tr>
        `).join('')
    }
})


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§ãƒ‘ãƒãƒ«.addEventListener('tabopen', async function(event){
    if(!ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.list){
        ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.list = await api.dir_list('/')
        ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.innerHTML += ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.list.map(dir =>`<option value="${dir}">${dir.replace(/^(....)/, '$1-')}</option>`).join('')
    }
})


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§æœˆåˆ¥.onchange = async function (event){
    if(!this.value){
        return
    }
    const files = await api.file_list(this.value)
    ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨.tBodies[0].innerHTML = files.map(file=>`
    <tr data-path="${this.value}/${file}">
      <td><a href="../upload/${this.value}/${file}" target="_blank">${file}</td>
      <td><span>&#10006;</span></td>
    </tr>
    `).join('')
}


ãƒ•ã‚¡ã‚¤ãƒ«ä¸€è¦§è¡¨.onclick = async function (event){
    if(event.target.tagName !== 'SPAN'){
        return
    }
    const tr = event.target.closest('tr')
    if(confirm('ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){
        await api.file_delete(tr.dataset.path)
        await tr.animate({opacity:0}, 300).finished
        tr.remove()
    }
}


æœ¬æ–‡æ¬„.ondrop = async function(event){
    event.preventDefault()

    for(const file of event.dataTransfer.files){
        const url = await api.file_save(file_path(file.name), file)
        console.dir(url)
    }
}


document.body.ondragover = function(event){
    event.preventDefault()
}

function file_path(name){
    const d  = new Date()
    const å¹´ = `${d.getFullYear()}`
    const æœˆ = `0${d.getMonth()+1}`.slice(-2)
    const æ—¥ = `0${d.getDate()}`.slice(-2)
    const æ™‚ = `0${d.getHours()}`.slice(-2)
    const åˆ† = `0${d.getMinutes()}`.slice(-2)
    const ç§’ = `0${d.getSeconds()}`.slice(-2)
    const ãƒŸãƒªç§’ = `00${d.getMilliseconds()}`.slice(-3)

    const pos = name.lastIndexOf('.')
    const ext = pos !== -1 ? name.slice(pos) : ''
    
    return `${å¹´}${æœˆ}/${å¹´}${æœˆ}${æ—¥}${æ™‚}${åˆ†}${ç§’}${ãƒŸãƒªç§’}${ext}`
}

async function start(){
    const query = new URLSearchParams(location.search)
    if(query.has('edit')){
        æ–°è¦æŠ•ç¨¿ãƒœã‚¿ãƒ³.remove()
        const data = await api.db('select * from ãƒã‚¹ã‚¿ãƒ¼ where ã‚¿ã‚¤ãƒˆãƒ« = ?', query.get('edit'), 'object');
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.setAttribute('readonly', true)
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.value = data.ã‚¿ã‚¤ãƒˆãƒ«
        æœ¬æ–‡æ¬„.value = data.æœ¬æ–‡
        ã‚«ãƒ†ã‚´ãƒªæ¬„.value = JSON.parse(data.ã‚«ãƒ†ã‚´ãƒª).join(',')
        è¿½åŠ ãƒ˜ãƒƒãƒ€æ¬„.value = data.è¿½åŠ ãƒ˜ãƒƒãƒ€
        document.title = `ã€Œ${data.ã‚¿ã‚¤ãƒˆãƒ«}ã€ã®ç·¨é›†`
        æœ¬æ–‡æ¬„.focus()
    }
    else{
        æ›´æ–°ãƒœã‚¿ãƒ³.remove()
        ã‚¿ã‚¤ãƒˆãƒ«æ¬„.focus()
    }
}

start()
</script>


</body>
</html>